# ã‚¤ãƒ³ãƒ•ãƒ©å†æ§‹ç¯‰ã¨Cloudflare DNSè‡ªå‹•åŒ– - å¤‰æ›´ã‚µãƒãƒªãƒ¼

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€2025å¹´12æœˆ20æ—¥ã«å®Ÿè£…ã—ãŸã€Œã‚¤ãƒ³ãƒ•ãƒ©å†æ§‹ç¯‰æ™‚ã®å®Œå…¨è‡ªå‹•åŒ–ã€ã«é–¢ã™ã‚‹å¤‰æ›´å†…å®¹ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

## ğŸ“‹ å®Ÿè£…å†…å®¹

### 1. Cloudflare Terraform Providerã®å°å…¥

Cloudflare DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’Terraformã§ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**:
- `terraform/environments/dev/main.tf`: Providerè¨­å®šã€DNSãƒ¬ã‚³ãƒ¼ãƒ‰å®šç¾©ã‚’è¿½åŠ 
- `terraform/environments/dev/variables.tf`: Cloudflareé–¢é€£ã®å¤‰æ•°ã‚’è¿½åŠ 
- `terraform/environments/dev/terraform.tfvars.example`: è¨­å®šä¾‹ã‚’ä½œæˆ

**ä¸»ãªæ©Ÿèƒ½**:
- ACMè¨¼æ˜æ›¸æ¤œè¨¼ç”¨CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰ã®è‡ªå‹•ä½œæˆ
- CloudFrontå‘ã‘CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰ã®è‡ªå‹•ä½œæˆ
- API Gatewayå‘ã‘CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰ã®è‡ªå‹•ä½œæˆ
- `enable_cloudflare_dns`ãƒ•ãƒ©ã‚°ã§ã‚ªãƒ—ãƒˆã‚¤ãƒ³æ–¹å¼ã®å°å…¥

### 2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å‚™

#### æ–°è¦ä½œæˆ

1. **`docs/rebuild-guide.md`**
   - `terraform destroy` â†’ `terraform apply` ã®å®Œå…¨ãªæ‰‹é †
   - æ‰‹å‹•DNSè¨­å®šã®è©³ç´°ã‚¬ã‚¤ãƒ‰
   - ACMè¨¼æ˜æ›¸æ¤œè¨¼ã®ç¢ºèªæ–¹æ³•
   - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
   - ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

2. **`docs/cloudflare-terraform-guide.md`**
   - Cloudflare Terraform Providerã¨ã¯
   - ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
   - Cloudflare APIãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—æ–¹æ³•ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä»˜ãã®è©³ç´°ã‚¬ã‚¤ãƒ‰ï¼‰
   - Zone IDã®å–å¾—æ–¹æ³•
   - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
   - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

3. **`adr/0004-cloudflare-terraform-provider.md`**
   - ãªãœCloudflare Providerã‚’å°å…¥ã—ãŸã‹
   - æ¤œè¨ã—ãŸä»£æ›¿æ¡ˆ
   - æ„æ€æ±ºå®šã®ç†ç”±
   - ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

#### æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°

- **`README.md`**: æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
- **`docs/deployment-guide.md`**: å†æ§‹ç¯‰ã‚¬ã‚¤ãƒ‰ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 

---

## ğŸš€ ä½¿ã„æ–¹

### Option A: æ‰‹å‹•ã§Cloudflare DNSã‚’è¨­å®šã™ã‚‹å ´åˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

å¾“æ¥é€šã‚Šã®æ–¹æ³•ã§ã™ã€‚è¿½åŠ ã®è¨­å®šã¯ä¸è¦ã§ã™ã€‚

```bash
cd terraform/environments/dev
terraform apply
# â†’ Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§æ‰‹å‹•è¨­å®š
```

è©³ç´°: [docs/rebuild-guide.md](rebuild-guide.md)

### Option B: Cloudflare DNSç®¡ç†ã‚’è‡ªå‹•åŒ–ã™ã‚‹å ´åˆ

å®Œå…¨è‡ªå‹•åŒ–ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§è¨­å®šã—ã¾ã™ï¼š

#### 1. Cloudflare APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—

[docs/cloudflare-terraform-guide.md](cloudflare-terraform-guide.md) ã®ã€Œã‚¹ãƒ†ãƒƒãƒ—1ã€ã‚’å‚ç…§

#### 2. terraform.tfvarsã‚’è¨­å®š

```bash
cd terraform/environments/dev
cp terraform.tfvars.example terraform.tfvars
```

`terraform.tfvars` ã‚’ç·¨é›†ï¼š

```hcl
aws_region = "ap-northeast-1"

enable_cloudflare_dns = true
cloudflare_api_token  = "your-api-token-here"
cloudflare_zone_id    = "your-zone-id-here"
```

#### 3. Terraformã‚’å®Ÿè¡Œ

```bash
terraform init  # Cloudflare Providerã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
terraform apply # DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚è‡ªå‹•ä½œæˆ
```

---

## ğŸ“Š Before / After

### Beforeï¼ˆæ‰‹å‹•ç®¡ç†ï¼‰

```
terraform apply
â†“
Terraformå‡ºåŠ›ã‚’ç¢ºèª
â†“
Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§æ‰‹å‹•è¨­å®šï¼ˆ5ã¤ã®CNAMEãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰
â†“
ACMè¨¼æ˜æ›¸æ¤œè¨¼å¾…ã¡ï¼ˆ5-30åˆ†ï¼‰
â†“
CloudFronté…å¸ƒå®Œäº†å¾…ã¡ï¼ˆ5-15åˆ†ï¼‰
â†“
S3ã¸é™çš„ã‚µã‚¤ãƒˆå†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
â†“
å®Œäº†ï¼ˆåˆè¨ˆ: 30-75åˆ†ï¼‰
```

**èª²é¡Œ**:
- æ‰‹å‹•ä½œæ¥­ãŒå¿…è¦ï¼ˆ5ã¤ã®DNSãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰
- ã‚¿ã‚¤ãƒã‚„è¨­å®šæ¼ã‚Œã®ãƒªã‚¹ã‚¯
- DNSè¨­å®šå€¤ã®ç¢ºèªãŒå¿…è¦
- æ™‚é–“ãŒã‹ã‹ã‚‹

### Afterï¼ˆè‡ªå‹•ç®¡ç†ï¼‰

```
terraform apply
â†“
å®Œäº†ï¼ˆåˆè¨ˆ: 20-40åˆ†ã€å…¨è‡ªå‹•ï¼‰
```

**æ”¹å–„ç‚¹**:
- âœ… æ‰‹å‹•ä½œæ¥­ãªã—
- âœ… äººç‚ºçš„ãƒŸã‚¹ã®é˜²æ­¢
- âœ… æ™‚é–“çŸ­ç¸®ï¼ˆ30-75åˆ† â†’ 20-40åˆ†ï¼‰
- âœ… DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ç®¡ç†
- âœ… å®Œå…¨ãªå†ç¾æ€§

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„äº‹é …

### APIãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†

Cloudflare APIãƒˆãƒ¼ã‚¯ãƒ³ã¯**æ©Ÿå¯†æƒ…å ±**ã§ã™ã€‚ä»¥ä¸‹ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼š

âœ… **æ¨å¥¨**:
- `terraform.tfvars` ã¯ `.gitignore` ã«å«ã¾ã‚Œã¦ã„ã‚‹ï¼ˆã‚³ãƒŸãƒƒãƒˆã•ã‚Œãªã„ï¼‰
- ç’°å¢ƒå¤‰æ•°ã§ã®ç®¡ç†ï¼ˆ`TF_VAR_cloudflare_api_token`ï¼‰
- CI/CDã§ã¯Secretsã«ä¿å­˜
- æœ€å°æ¨©é™ã®åŸå‰‡ï¼ˆZone DNS Editã®ã¿ï¼‰

âŒ **ç¦æ­¢**:
- Gitãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆ
- å…¬é–‹ãƒãƒ£ãƒƒãƒˆãƒ»ãƒ¡ãƒ¼ãƒ«ã§å…±æœ‰
- ç®¡ç†è€…æ¨©é™ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨

### State fileã®ç®¡ç†

Terraform State fileã«ã‚‚APIãƒˆãƒ¼ã‚¯ãƒ³ãŒä¿å­˜ã•ã‚Œã¾ã™ï¼š

**æ¨å¥¨**: S3ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ï¼ˆæš—å·åŒ–+ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰

```hcl
terraform {
  backend "s3" {
    bucket         = "your-terraform-state-bucket"
    key            = "dev/terraform.tfstate"
    region         = "ap-northeast-1"
    encrypt        = true
    dynamodb_table = "terraform-state-lock"
  }
}
```

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | å†…å®¹ |
|------------|------|
| [rebuild-guide.md](rebuild-guide.md) | ã‚¤ãƒ³ãƒ•ãƒ©å†æ§‹ç¯‰ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰ |
| [cloudflare-terraform-guide.md](cloudflare-terraform-guide.md) | Cloudflare Terraformå°å…¥ã‚¬ã‚¤ãƒ‰ |
| [deployment-guide.md](deployment-guide.md) | åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰ |
| [adr/0004-cloudflare-terraform-provider.md](../adr/0004-cloudflare-terraform-provider.md) | è¨­è¨ˆæ±ºå®šã®è¨˜éŒ² |

---

## ğŸ¯ ä»Šå¾Œã®å±•é–‹

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼š

1. **å®Œå…¨ãªIaCåŒ–**
   - ã‚¤ãƒ³ãƒ•ãƒ©ã®ã™ã¹ã¦ãŒã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã•ã‚Œã‚‹
   - `git clone` â†’ `terraform apply` ã ã‘ã§ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½

2. **è¤‡æ•°ç’°å¢ƒã®ç®¡ç†**
   - dev/staging/prod ã‚’åŒã˜ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†
   - ç’°å¢ƒã”ã¨ã®å·®åˆ†ã‚’å¤‰æ•°ã§å¸å

3. **CI/CDã®å®Œå…¨è‡ªå‹•åŒ–**
   - GitHub Actionsã§å…¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½
   - PRã§ã®planã€mainãƒ–ãƒ©ãƒ³ãƒã§apply

4. **ç½å®³å¾©æ—§ï¼ˆDRï¼‰ã®ç°¡ç´ åŒ–**
   - éšœå®³æ™‚ã®å¾©æ—§ãŒè¿…é€Ÿ
   - åŒã˜ã‚³ãƒ¼ãƒ‰ã§åˆ¥ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«å¾©æ—§å¯èƒ½

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- [ ] `.gitignore` ã« `*.tfvars` ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸ
- [ ] Cloudflare Terraformå°å…¥ã‚¬ã‚¤ãƒ‰ã‚’èª­ã‚“ã 
- [ ] å†æ§‹ç¯‰ã‚¬ã‚¤ãƒ‰ã‚’èª­ã‚“ã 
- [ ] æ‰‹å‹•ç®¡ç†ã¨è‡ªå‹•ç®¡ç†ã®ã©ã¡ã‚‰ã‚’æ¡ç”¨ã™ã‚‹ã‹æ±ºã‚ãŸ
- [ ] è‡ªå‹•ç®¡ç†ã‚’æ¡ç”¨ã™ã‚‹å ´åˆã€APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ãŸ
- [ ] `terraform.tfvars.example` ã‚’å‚è€ƒã«è¨­å®šã—ãŸ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’ç†è§£ã—ãŸ

---

**æ›´æ–°æ—¥**: 2025å¹´12æœˆ20æ—¥  
**ä½œæˆè€…**: Development Team  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0

