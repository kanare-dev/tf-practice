name: Deploy Static Site to S3

on:
  push:
    branches:
      - main
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-static-site.yml"
  pull_request:
    branches:
      - main
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-static-site.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v3

      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Set environment variables
        id: set-vars
        run: |
          if [ "${{ steps.set-env.outputs.environment }}" == "prod" ]; then
            echo "bucket_name=note-app.kanare.dev" >> $GITHUB_OUTPUT
            echo "domain_name=note-app.kanare.dev" >> $GITHUB_OUTPUT
            echo "api_base_url=https://api.note-app.kanare.dev" >> $GITHUB_OUTPUT
          else
            echo "bucket_name=dev.note-app.kanare.dev" >> $GITHUB_OUTPUT
            echo "domain_name=dev.note-app.kanare.dev" >> $GITHUB_OUTPUT
            echo "api_base_url=https://api-dev.note-app.kanare.dev" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Check if S3 bucket exists
        run: |
          if ! aws s3 ls "s3://${{ steps.set-vars.outputs.bucket_name }}" > /dev/null 2>&1; then
            echo "âŒ S3ãƒã‚±ãƒƒãƒˆ ${{ steps.set-vars.outputs.bucket_name }} ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            echo "ğŸ’¡ å…ˆã«Terraformã§ ${{ steps.set-env.outputs.environment }} ç’°å¢ƒã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„"
            exit 1
          fi
          echo "âœ… S3ãƒã‚±ãƒƒãƒˆ ${{ steps.set-vars.outputs.bucket_name }} ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Get Cognito configuration from Terraform outputs
        id: get-cognito
        run: |
          cd terraform/environments/${{ steps.set-env.outputs.environment }}

          # Terraform init (backendè¨­å®šã‚’èª­ã¿è¾¼ã‚€ãŸã‚)
          echo "Initializing Terraform..."
          if terraform init > /dev/null 2>&1; then
            echo "âœ… Terraform initialized successfully"

            # Terraform outputsã‹ã‚‰å€¤ã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’å®Œå…¨ã«ç„¡è¦–ï¼‰
            USER_POOL_ID=$(terraform output -raw cognito_user_pool_id 2>&1 | grep -v "â•·" | grep -v "â”‚" | grep -v "â•µ" | head -n1 || echo "")
            USER_POOL_CLIENT_ID=$(terraform output -raw cognito_user_pool_client_id 2>&1 | grep -v "â•·" | grep -v "â”‚" | grep -v "â•µ" | head -n1 || echo "")

            # å‡ºåŠ›å€¤ã®æ¤œè¨¼ï¼ˆAWS User Pool IDã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼‰
            if [[ "$USER_POOL_ID" =~ ^[a-z]+-[a-z]+-[0-9]+_[a-zA-Z0-9]+$ ]] && [[ "$USER_POOL_CLIENT_ID" =~ ^[a-zA-Z0-9]+$ ]]; then
              echo "âœ… Terraform outputsã‹ã‚‰Cognitoè¨­å®šã‚’å–å¾—ã—ã¾ã—ãŸ"
              echo "user_pool_id=$USER_POOL_ID" >> $GITHUB_OUTPUT
              echo "user_pool_client_id=$USER_POOL_CLIENT_ID" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Terraform outputs validation failed. Using Secrets..."
              USER_POOL_ID=""
              USER_POOL_CLIENT_ID=""
            fi
          else
            echo "âš ï¸ Terraform init failed. Using Secrets..."
            USER_POOL_ID=""
            USER_POOL_CLIENT_ID=""
          fi

          # Secretsã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          if [ -z "$USER_POOL_ID" ] || [ -z "$USER_POOL_CLIENT_ID" ]; then
            if [ "${{ steps.set-env.outputs.environment }}" == "prod" ]; then
              echo "user_pool_id=${{ secrets.VITE_USER_POOL_ID }}" >> $GITHUB_OUTPUT
              echo "user_pool_client_id=${{ secrets.VITE_USER_POOL_CLIENT_ID }}" >> $GITHUB_OUTPUT
            else
              echo "user_pool_id=${{ secrets.VITE_USER_POOL_ID_DEV }}" >> $GITHUB_OUTPUT
              echo "user_pool_client_id=${{ secrets.VITE_USER_POOL_CLIENT_ID_DEV }}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build static site
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_BASE_URL: ${{ steps.set-vars.outputs.api_base_url }}
          VITE_AWS_REGION: ap-northeast-1
          VITE_USER_POOL_ID: ${{ steps.get-cognito.outputs.user_pool_id }}
          VITE_USER_POOL_CLIENT_ID: ${{ steps.get-cognito.outputs.user_pool_client_id }}

      - name: Sync static files to S3
        run: |
          aws s3 sync frontend/dist/ s3://${{ steps.set-vars.outputs.bucket_name }}/ --delete
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: https://${{ steps.set-vars.outputs.domain_name }}"

      - name: Get CloudFront distribution ID
        id: get-cloudfront
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Aliases.Items[?contains(@, '${{ steps.set-vars.outputs.domain_name }}')]].Id | [0]" \
            --output text)

          if [ "$DISTRIBUTION_ID" != "None" ] && [ -n "$DISTRIBUTION_ID" ]; then
            echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
            echo "âœ… CloudFront Distribution ID: $DISTRIBUTION_ID"
          else
            echo "âš ï¸ CloudFront distributionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "distribution_id=" >> $GITHUB_OUTPUT
          fi

      - name: Invalidate CloudFront cache
        if: steps.get-cloudfront.outputs.distribution_id != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.get-cloudfront.outputs.distribution_id }} \
            --paths "/*"
          echo "âœ… CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### ğŸš€ Static Site Deployed to **${{ steps.set-env.outputs.environment }}** environment

            **Preview URL**: https://${{ steps.set-vars.outputs.domain_name }}

            **Environment Details**:
            - S3 Bucket: \`${{ steps.set-vars.outputs.bucket_name }}\`
            - API URL: \`${{ steps.set-vars.outputs.api_base_url }}\`
            - CloudFront: ${steps.get-cloudfront.outputs.distribution_id ? 'âœ… Cache invalidated' : 'âš ï¸ No distribution found'}

            *Deployed by: @${{ github.actor }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
